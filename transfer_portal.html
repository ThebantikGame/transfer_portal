<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–°–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –ë—É—Ñ–µ—Ä –ö–æ–¥–∞</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Telegram Web App API (–ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û –¥–ª—è MainButton –∏ —Ç–µ–º) -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <!-- Firebase Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, serverTimestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ Canvas
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db;
        let auth;
        let userId = '';
        let isAuthReady = false;

        const STORAGE_KEY = 'transfer_content'; // –ö–ª—é—á –¥–æ–∫—É–º–µ–Ω—Ç–∞ Firestore

        const inputField = document.getElementById('content-input');
        const statusText = document.getElementById('status-text');
        const copyButton = document.getElementById('copy-button');
        const lastUpdatedText = document.getElementById('last-updated');

        // --- –£–¢–ò–õ–ò–¢–´ TWA –ò UI ---

        if (window.Telegram && Telegram.WebApp) {
            Telegram.WebApp.ready();
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ü–≤–µ—Ç–∞ –∏–∑ TWA –¥–ª—è –±–µ—Å—à–æ–≤–Ω–æ–≥–æ –¥–∏–∑–∞–π–Ω–∞
            document.documentElement.style.setProperty('--bg-color', Telegram.WebApp.themeParams.bg_color);
            document.documentElement.style.setProperty('--text-color', Telegram.WebApp.themeParams.text_color);
            document.documentElement.style.setProperty('--hint-color', Telegram.WebApp.themeParams.hint_color);
            document.documentElement.style.setProperty('--link-color', Telegram.WebApp.themeParams.link_color);

            // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –ì–ª–∞–≤–Ω—É—é –ö–Ω–æ–ø–∫—É TWA –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
            Telegram.WebApp.MainButton.setText('üíæ –°–û–•–†–ê–ù–ò–¢–¨ –ò –°–ò–ù–•–†–û–ù–ò–ó–ò–†–û–í–ê–¢–¨').show();
            Telegram.WebApp.MainButton.onClick(saveContent);
        }

        // –í—ã–≤–æ–¥ –Ω–∞—Ç–∏–≤–Ω–æ–≥–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è TWA
        function showTwaAlert(message, isError = false) {
            if (window.Telegram && Telegram.WebApp) {
                if (isError) {
                    Telegram.WebApp.showAlert(`‚ùå –û—à–∏–±–∫–∞: ${message}`);
                } else {
                    Telegram.WebApp.showPopup({ message: message, buttons: [{ text: '–û–ö' }] });
                }
            } else {
                console.log(message);
            }
        }

        function setStatus(text, type = 'info') {
            let color = 'text-gray-400';
            if (type === 'success') color = 'text-green-400';
            if (type === 'error') color = 'text-red-400';
            
            statusText.className = `text-sm mt-2 ${color}`;
            statusText.textContent = text;
        }

        // --- –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø FIREBASE –ò –ê–£–¢–ï–ù–¢–ò–§–ò–ö–ê–¶–ò–Ø ---

        async function initializeFirebase() {
            if (Object.keys(firebaseConfig).length === 0) {
                 setStatus('–û—à–∏–±–∫–∞: –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Firebase –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç.', 'error');
                 return;
            }
            
            try {
                if (window.Telegram && Telegram.WebApp) Telegram.WebApp.showProgress(true); // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º TWA –ª–æ–∞–¥–µ—Ä
                
                // setLogLevel('Debug'); // –†–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
                
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                // –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
                
                userId = auth.currentUser?.uid || crypto.randomUUID();
                isAuthReady = true;
                
                setStatus('–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ. –ù–∞—á–∏–Ω–∞–µ–º —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é...', 'info');
                startRealtimeListener();

            } catch (error) {
                console.error("–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ Firebase:", error);
                setStatus(`–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: ${error.message}`, 'error');
                showTwaAlert(`–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è: ${error.message}`, true);
            } finally {
                if (window.Telegram && Telegram.WebApp) Telegram.WebApp.showProgress(false);
            }
        }

        // --- FIREBASE: –°–õ–£–®–ê–¢–ï–õ–¨ –†–ï–ê–õ–¨–ù–û–ì–û –í–†–ï–ú–ï–ù–ò (SYNCHRONOUS) ---
        
        // –ü—É—Ç—å –∫ –ø—É–±–ª–∏—á–Ω–æ–º—É –¥–æ–∫—É–º–µ–Ω—Ç—É –¥–ª—è –æ–±–º–µ–Ω–∞ (–ø—Ä–∏–≤–∞—Ç–Ω—ã–π –≤ —Ä–∞–º–∫–∞—Ö —ç—Ç–æ–≥–æ App ID)
        const transferPath = `artifacts/${appId}/public/data/shared_data/${STORAGE_KEY}`;

        function startRealtimeListener() {
            if (!db || !isAuthReady) return;

            const docRef = doc(db, transferPath);

            onSnapshot(docRef, (docSnapshot) => {
                if (docSnapshot.exists()) {
                    const data = docSnapshot.data();
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞, –¢–û–õ–¨–ö–û –µ—Å–ª–∏ –æ–Ω–æ –Ω–µ –∞–∫—Ç–∏–≤–Ω–æ (—á—Ç–æ–±—ã –Ω–µ –º–µ—à–∞—Ç—å –ø–µ—á–∞—Ç–∞—Ç—å)
                    if (document.activeElement !== inputField) {
                        inputField.value = data.content || '';
                    }

                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å
                    setStatus('–ë—É—Ñ–µ—Ä —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω —Å –æ–±–ª–∞–∫–æ–º.', 'success');
                    
                    if (data.timestamp) {
                        const date = data.timestamp.toDate ? data.timestamp.toDate() : new Date();
                        lastUpdatedText.textContent = date.toLocaleTimeString('ru-RU', {
                            hour: '2-digit', minute: '2-digit', second: '2-digit'
                        }) + " (–ú–≥–Ω–æ–≤–µ–Ω–Ω–æ)";
                    } else {
                        lastUpdatedText.textContent = '–¢–æ–ª—å–∫–æ —á—Ç–æ —Å–æ–∑–¥–∞–Ω';
                    }

                } else {
                    setStatus('–ë—É—Ñ–µ—Ä –ø—É—Å—Ç. –°–æ—Ö—Ä–∞–Ω–∏—Ç–µ —á—Ç–æ-–Ω–∏–±—É–¥—å –¥–ª—è –æ–±–º–µ–Ω–∞.', 'info');
                    inputField.value = '';
                    lastUpdatedText.textContent = '--';
                }
            }, (error) => {
                console.error("–û—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏:", error);
                setStatus(`–û—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö: ${error.message}`, 'error');
            });
        }
        
        // --- FIREBASE: –°–û–•–†–ê–ù–ï–ù–ò–ï –î–ê–ù–ù–´–• ---
        
        async function saveContent() {
            if (!db || !userId || !isAuthReady) {
                showTwaAlert("–°–Ω–∞—á–∞–ª–∞ –¥–æ–∂–¥–∏—Ç–µ—Å—å –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.", true);
                return;
            }

            if (inputField.value.length > 100000) {
                 showTwaAlert('–°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ —Å–∏–º–≤–æ–ª–æ–≤ (–ú–∞–∫—Å–∏–º—É–º 100,000).', true);
                 return;
            }

            if (window.Telegram && Telegram.WebApp) Telegram.WebApp.MainButton.showLoader();
            
            try {
                const docRef = doc(db, transferPath);
                
                await setDoc(docRef, {
                    content: inputField.value,
                    timestamp: serverTimestamp(),
                    user_id: userId,
                    app_id: appId
                });
                
                showTwaAlert('‚úÖ –î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω—ã –Ω–∞ –≤—Å–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞!', false);

            } catch (error) {
                console.error("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö:", error);
                setStatus(`–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ${error.message}`, 'error');
                showTwaAlert(`–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å: ${error.message}`, true);
            } finally {
                if (window.Telegram && Telegram.WebApp) Telegram.WebApp.MainButton.hideLoader();
            }
        }

        // --- –ö–û–ü–ò–†–û–í–ê–ù–ò–ï ---

        async function copyToClipboard() {
            const content = inputField.value;
            if (!content) {
                showTwaAlert("–ë—É—Ñ–µ—Ä –ø—É—Å—Ç, –Ω–µ—á–µ–≥–æ –∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å.", true);
                return;
            }
            
            if (navigator.clipboard && navigator.clipboard.writeText) {
                try {
                    await navigator.clipboard.writeText(content);
                    showTwaAlert('üìã –í–µ—Å—å –∫–æ–Ω—Ç–µ–Ω—Ç —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞!', false);
                } catch (err) {
                    fallbackCopy();
                }
            } else {
                fallbackCopy();
            }
        }
        
        // –†–µ–∑–µ—Ä–≤–Ω—ã–π –º–µ—Ç–æ–¥ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è (–¥–ª—è iFrame/—Å—Ç–∞—Ä—ã—Ö –±—Ä–∞—É–∑–µ—Ä–æ–≤)
        function fallbackCopy() {
            inputField.select();
            try {
                document.execCommand('copy');
                showTwaAlert('üìã –ö–æ–Ω—Ç–µ–Ω—Ç —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω (—Ä–µ–∑–µ—Ä–≤–Ω—ã–π –º–µ—Ç–æ–¥)!', false);
            } catch (err) {
                showTwaAlert('–û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –≤—ã–¥–µ–ª–∏—Ç—å –∏ —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –≤—Ä—É—á–Ω—É—é.', true);
                console.error('–û—à–∏–±–∫–∞ —Ä–µ–∑–µ—Ä–≤–Ω–æ–≥–æ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è:', err);
            }
        }
        
        // --- –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò ---
        
        copyButton.addEventListener('click', copyToClipboard);

        // –ó–∞–ø—É—Å–∫
        window.onload = initializeFirebase;

    </script>
    <style>
        /* –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ TWA */
        :root {
            --bg-color: #1a1a1a;
            --text-color: #f4f4f5;
            --hint-color: #a1a1aa;
            --link-color: #6366f1;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: background-color 0.3s;
        }
        
        .app-container {
            background-color: #27272a; 
            border: 1px solid #3f3f46;
        }
        .textarea-custom {
            min-height: 350px; 
            background-color: #18181b; 
            color: var(--text-color); 
            border-color: #4b5563;
        }
        
        /* –ö–Ω–æ–ø–∫–∏, –∫–æ—Ç–æ—Ä—ã–µ –æ—Å—Ç–∞—é—Ç—Å—è –≤ HTML */
        .html-button {
            background-color: #6366f1;
            color: white;
            transition: background-color 0.3s;
        }
        .html-button:hover {
            background-color: #4f46e5;
        }
        
        /* –°—Ç–∏–ª–∏–∑–∞—Ü–∏—è –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤ */
        @media (min-width: 640px) {
            .textarea-custom {
                min-height: 500px;
            }
        }
    </style>
</head>
<body class="p-4 md:p-8 min-h-screen flex flex-col items-center">

    <div class="max-w-3xl w-full">
        <h1 class="text-2xl md:text-3xl font-bold text-center text-indigo-400 mb-6 pb-2">
            üöÄ –û–±—â–∏–π –ë—É—Ñ–µ—Ä –ö–æ–¥–∞ (IMBA Sync)
        </h1>
        <p id="disclaimer" class="text-center text-sm text-gray-400 mb-6">
            –í–∞—à –ª–∏—á–Ω—ã–π –±—É—Ñ–µ—Ä, —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –º–µ–∂–¥—É –≤—Å–µ–º–∏ –≤–∞—à–∏–º–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞–º–∏.
        </p>

        <!-- –†–∞–±–æ—á–∞—è –∫–∞—Ä—Ç–æ—á–∫–∞ -->
        <div class="app-container p-5 md:p-8 rounded-2xl shadow-2xl">
            <label for="content-input" class="block text-lg font-semibold text-gray-200 mb-3">
                –†–∞–±–æ—á–∞—è –æ–±–ª–∞—Å—Ç—å (–¥–æ 100K —Å–∏–º–≤–æ–ª–æ–≤):
            </label>
            <textarea id="content-input" 
                      maxlength="100000"
                      placeholder="–í—Å—Ç–∞–≤—å—Ç–µ —Ç–µ–∫—Å—Ç –∏–ª–∏ –∫–æ–¥ —Å—é–¥–∞..."
                      class="textarea-custom w-full p-4 rounded-xl border-2 focus:ring-indigo-500 focus:border-indigo-500 text-base shadow-inner resize-none">
            </textarea>
            
            <!-- –ö–Ω–æ–ø–∫–∞ –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å (–æ—Å—Ç–∞–µ—Ç—Å—è –≤ HTML, —Ç.–∫. –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –≤—Å–µ–≥–æ –ø–æ–ª—è) -->
            <div class="mt-4">
                <button id="copy-button" 
                        class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 rounded-xl transition duration-300 shadow-lg">
                    üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –í–µ—Å—å –ö–æ–Ω—Ç–µ–Ω—Ç
                </button>
            </div>
            
        </div>
        
        <!-- –°–µ–∫—Ü–∏—è —Å—Ç–∞—Ç—É—Å–∞ -->
        <div class="mt-4 flex flex-col sm:flex-row justify-between items-center text-xs">
            <p class="text-gray-500">–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: <span id="last-updated">--</span></p>
            <p id="status-text" class="text-sm mt-2 sm:mt-0 text-gray-400">–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è...</p>
        </div>
        
        <p class="text-xs text-center text-gray-600 mt-8">
            –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è —á–µ—Ä–µ–∑ –Ω–∞—Ç–∏–≤–Ω—É—é —Å–∏–Ω—é—é –∫–Ω–æ–ø–∫—É Telegram –≤–Ω–∏–∑—É —ç–∫—Ä–∞–Ω–∞.
        </p>

    </div>
</body>
</html>
