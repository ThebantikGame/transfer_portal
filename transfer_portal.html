<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ULTIMATE TWA SYNC PORTAL</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Telegram Web App API (CRITICAL for MainButton and theming) -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <!-- Firebase Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, serverTimestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global Canvas variables (MANDATORY USE)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'gh-pages-sync-portal'; 
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // =========================================================================
        // === –í–ê–ñ–ù–û: –†–£–ß–ù–ê–Ø –ù–ê–°–¢–†–û–ô–ö–ê FIREBASE (–ö–õ–Æ–ß–ò –í–ó–Ø–¢–´ –ò–ó –í–ê–®–ï–ô –ö–û–ù–°–û–õ–ò) ===
        // =========================================================================

        const EXTERNAL_FIREBASE_CONFIG = {
            // –ö–ª—é—á–∏ –∏–∑ —Å–∫—Ä–∏–Ω—à–æ—Ç–∞: –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ.png-e7e8913b-b23d-4c54-9e79-8d19a4e931fa
            apiKey: "AIzaSyDwnzdPSkkSN_v715kZ_WlSMrLHlSIrtisPyK", 
            authDomain: "quad-715a9.firebaseapp.com",
            projectId: "quad-715a9", 
            storageBucket: "quad-715a9.appspot.com",
            messagingSenderId: "898041763356", 
            appId: "1:898041763356:web:792f8669e08088e9cd31d9", 
            measurementId: "G-SPJBMW31D7" // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π ID, —Ç–∞–∫–∂–µ –∏–∑ —Å–∫—Ä–∏–Ω–∞
        };

        // =========================================================================

        let firebaseConfig;

        if (typeof __firebase_config !== 'undefined' && __firebase_config) {
             try {
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º –±–µ–∑–æ–ø–∞—Å–Ω—É—é –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é Canvas
                firebaseConfig = JSON.parse(__firebase_config);
             } catch (e) {
                firebaseConfig = EXTERNAL_FIREBASE_CONFIG;
             }
        } else {
             // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ä—É—á–Ω—É—é –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –¥–ª—è GitHub Pages
             firebaseConfig = EXTERNAL_FIREBASE_CONFIG;
        }

        let db;
        let auth;
        let userId = '';
        let isAuthReady = false;

        const STORAGE_KEY = 'ultimate_transfer_content'; 

        const inputField = document.getElementById('content-input');
        const statusText = document.getElementById('status-text');
        const copyButton = document.getElementById('copy-button');
        const lastUpdatedText = document.getElementById('last-updated');

        // --- TWA UTILITIES AND UI SETUP ---

        if (window.Telegram && Telegram.WebApp) {
            Telegram.WebApp.ready();
            // Apply TWA theme colors for seamless integration
            document.documentElement.style.setProperty('--bg-color', Telegram.WebApp.themeParams.bg_color);
            document.documentElement.style.setProperty('--text-color', Telegram.WebApp.themeParams.text_color);
            document.documentElement.style.setProperty('--hint-color', Telegram.WebApp.themeParams.hint_color);
            document.documentElement.style.setProperty('--link-color', Telegram.WebApp.themeParams.link_color);
            
            // Set up the Native Telegram MainButton for saving (most reliable action)
            Telegram.WebApp.MainButton.setText('üíæ –°–û–•–†–ê–ù–ò–¢–¨ –ò –°–ò–ù–•–†–û–ù–ò–ó–ò–†–û–í–ê–¢–¨ üöÄ').show();
            Telegram.WebApp.MainButton.onClick(saveContent);
        }

        // Display native TWA notification
        function showTwaAlert(message, isError = false) {
            if (window.Telegram && Telegram.WebApp) {
                if (isError) {
                    Telegram.WebApp.showAlert(`‚ùå –û—à–∏–±–∫–∞: ${message}`);
                } else {
                    Telegram.WebApp.showPopup({ message: message, buttons: [{ text: '–û–ö' }] });
                }
            } else {
                console.log(message);
            }
        }

        // Update status text on the UI
        function setStatus(text, type = 'info') {
            let color = 'text-gray-400';
            if (type === 'success') color = 'text-green-400';
            if (type === 'error') color = 'text-red-400';
            
            statusText.className = `text-sm mt-2 ${color}`;
            statusText.textContent = text;
        }

        // --- FIREBASE INITIALIZATION AND AUTHENTICATION ---

        async function initializeFirebase() {
            if (Object.keys(firebaseConfig).length === 0 || !firebaseConfig.projectId) {
                 setStatus('‚ùå –û—à–∏–±–∫–∞: –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ Firebase.', 'error');
                 return;
            }
            
            try {
                if (window.Telegram && Telegram.WebApp) Telegram.WebApp.showProgress(true);
                
                // setLogLevel('Debug');
                
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                // Authentication
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
                
                userId = auth.currentUser?.uid || crypto.randomUUID();
                isAuthReady = true;
                
                setStatus('üöÄ –£—Å–ø–µ—à–Ω–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–æ. –ó–∞–ø—É—Å–∫–∞–µ–º —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é...', 'info');
                startRealtimeListener();

            } catch (error) {
                console.error("Firebase initialization error:", error);
                setStatus(`–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: ${error.message}`, 'error');
                showTwaAlert(`–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è: ${error.message}`, true);
            } finally {
                if (window.Telegram && Telegram.WebApp) Telegram.WebApp.showProgress(false);
            }
        }

        // --- FIREBASE: REALTIME LISTENER (SYNCHRONOUS) ---
        
        // Public path for synchronization (unique to this App ID)
        const transferPath = `artifacts/${appId}/public/data/shared_data/${STORAGE_KEY}`;

        function startRealtimeListener() {
            if (!db || !isAuthReady) return;

            const docRef = doc(db, transferPath);

            onSnapshot(docRef, (docSnapshot) => {
                if (docSnapshot.exists()) {
                    const data = docSnapshot.data();
                    
                    // Update input field, but ONLY if the user is not actively typing/focused
                    if (document.activeElement !== inputField) {
                        inputField.value = data.content || '';
                    }

                    // Update status
                    setStatus('‚úÖ –ë—É—Ñ–µ—Ä –º–≥–Ω–æ–≤–µ–Ω–Ω–æ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω.', 'success');
                    
                    if (data.timestamp) {
                        const date = data.timestamp.toDate ? data.timestamp.toDate() : new Date();
                        lastUpdatedText.textContent = date.toLocaleTimeString('ru-RU', {
                            hour: '2-digit', minute: '2-digit', second: '2-digit'
                        });
                    } else {
                        lastUpdatedText.textContent = '–¢–æ–ª—å–∫–æ —á—Ç–æ —Å–æ–∑–¥–∞–Ω';
                    }

                } else {
                    setStatus('–ë—É—Ñ–µ—Ä –ø—É—Å—Ç. –ù–∞—á–Ω–∏—Ç–µ –æ–±–º–µ–Ω –¥–∞–Ω–Ω—ã–º–∏.', 'info');
                    inputField.value = '';
                    lastUpdatedText.textContent = '--';
                }
            }, (error) => {
                console.error("Synchronization error:", error);
                setStatus(`–û—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö: ${error.message}`, 'error');
            });
        }
        
        // --- FIREBASE: SAVE DATA (TRIGGERED BY MAINBUTTON) ---
        
        async function saveContent() {
            if (!db || !userId || !isAuthReady) {
                showTwaAlert("–°–Ω–∞—á–∞–ª–∞ –¥–æ–∂–¥–∏—Ç–µ—Å—å –ø–æ–ª–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.", true);
                return;
            }

            if (inputField.value.length > 100000) {
                 showTwaAlert('–°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ —Å–∏–º–≤–æ–ª–æ–≤ (–ú–∞–∫—Å–∏–º—É–º 100,000).', true);
                 return;
            }

            if (window.Telegram && Telegram.WebApp) Telegram.WebApp.MainButton.showLoader();
            
            try {
                const docRef = doc(db, transferPath);
                
                await setDoc(docRef, {
                    content: inputField.value,
                    timestamp: serverTimestamp(),
                    user_id: userId,
                    app_id: appId
                });
                
                showTwaAlert('üöÄ –î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω—ã –Ω–∞ –≤—Å–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞!', false);

            } catch (error) {
                console.error("Data save error:", error);
                setStatus(`–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ${error.message}`, 'error');
                showTwaAlert(`–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å: ${error.message}`, true);
            } finally {
                if (window.Telegram && Telegram.WebApp) Telegram.WebApp.MainButton.hideLoader();
            }
        }

        // --- COPY FUNCTIONALITY ---

        async function copyToClipboard() {
            const content = inputField.value;
            if (!content) {
                showTwaAlert("–ë—É—Ñ–µ—Ä –ø—É—Å—Ç, –Ω–µ—á–µ–≥–æ –∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å.", true);
                return;
            }
            
            if (navigator.clipboard && navigator.clipboard.writeText) {
                try {
                    await navigator.clipboard.writeText(content);
                    showTwaAlert('üìã –í–µ—Å—å –∫–æ–Ω—Ç–µ–Ω—Ç —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞!', false);
                } catch (err) {
                    fallbackCopy();
                }
            } else {
                fallbackCopy();
            }
        }
        
        // Fallback method for iFrames/older browsers
        function fallbackCopy() {
            inputField.select();
            try {
                document.execCommand('copy');
                showTwaAlert('üìã –ö–æ–Ω—Ç–µ–Ω—Ç —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω (—Ä–µ–∑–µ—Ä–≤–Ω—ã–π –º–µ—Ç–æ–¥)!', false);
            } catch (err) {
                showTwaAlert('–û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –≤—ã–¥–µ–ª–∏—Ç—å –∏ —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –≤—Ä—É—á–Ω—É—é.', true);
                console.error('Fallback copy error:', err);
            }
        }
        
        // --- EVENT HANDLERS ---
        
        copyButton.addEventListener('click', copyToClipboard);

        // Start initialization
        window.onload = initializeFirebase;

    </script>
    <style>
        /* TWA Variables */
        :root {
            --bg-color: #1a1a1a;
            --text-color: #f4f4f5;
            --hint-color: #a1a1aa;
            --link-color: #6366f1;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: background-color 0.3s;
        }
        
        .app-container {
            /* TWA-like card style */
            background-color: #27272a; 
            border: 1px solid #3f3f46;
        }
        .textarea-custom {
            /* Large, dark, high-contrast input */
            min-height: 400px; 
            background-color: #18181b; 
            color: var(--text-color); 
            border-color: #4b5563;
            font-size: 16px; /* Larger font for readability */
        }
        
        /* Copy button style (uses standard Tailwind classes) */
        .copy-button {
            background-color: #4ade80; /* Green-400 */
            color: #1a1a1a;
        }
        .copy-button:hover {
            background-color: #16a34a; /* Green-600 */
        }
        
        /* Mobile optimization */
        @media (min-width: 640px) {
            .textarea-custom {
                min-height: 550px;
            }
        }
    </style>
</head>
<body class="p-4 md:p-8 min-h-screen flex flex-col items-center">

    <div class="max-w-3xl w-full">
        <h1 class="text-2xl md:text-3xl font-extrabold text-center text-yellow-300 mb-6 pb-2 border-b border-yellow-300/50">
            ‚≠ê ULTIMATE TWA SYNC PORTAL ‚≠ê
        </h1>
        <p class="text-center text-sm text-gray-400 mb-6">
            –í–∞—à –ª–∏—á–Ω—ã–π, –º–≥–Ω–æ–≤–µ–Ω–Ω—ã–π, –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã–π –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞ –º–µ–∂–¥—É –ü–ö –∏ –¢–µ–ª–µ—Ñ–æ–Ω–æ–º.
        </p>

        <!-- –†–∞–±–æ—á–∞—è –∫–∞—Ä—Ç–æ—á–∫–∞ -->
        <div class="app-container p-5 md:p-8 rounded-2xl shadow-2xl">
            <label for="content-input" class="block text-xl font-semibold text-gray-100 mb-3">
                –†–∞–±–æ—á–∞—è –æ–±–ª–∞—Å—Ç—å (–¥–æ 100K —Å–∏–º–≤–æ–ª–æ–≤):
            </label>
            <textarea id="content-input" 
                      maxlength="100000"
                      placeholder="–í—Å—Ç–∞–≤—å—Ç–µ —Ç–µ–∫—Å—Ç –∏–ª–∏ –∫–æ–¥ —Å—é–¥–∞. –°–æ—Ö—Ä–∞–Ω–∏—Ç–µ —á–µ—Ä–µ–∑ —Å–∏–Ω—é—é –∫–Ω–æ–ø–∫—É –≤–Ω–∏–∑—É —ç–∫—Ä–∞–Ω–∞..."
                      class="textarea-custom w-full p-4 rounded-xl border-2 focus:ring-indigo-500 focus:border-indigo-500 shadow-inner resize-none">
            </textarea>
            
            <!-- –ö–Ω–æ–ø–∫–∞ –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å -->
            <div class="mt-4">
                <button id="copy-button" 
                        class="copy-button w-full font-bold py-4 rounded-xl transition duration-300 shadow-lg text-lg">
                    üìã –ú–ì–ù–û–í–ï–ù–ù–û –°–ö–û–ü–ò–†–û–í–ê–¢–¨ –í–ï–°–¨ –ö–û–ù–¢–ï–ù–¢
                </button>
            </div>
            
        </div>
        
        <!-- –°–µ–∫—Ü–∏—è —Å—Ç–∞—Ç—É—Å–∞ -->
        <div class="mt-4 flex flex-col sm:flex-row justify-between items-start text-xs">
            <p class="text-gray-500 text-sm">–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: <span id="last-updated" class="text-gray-300">--</span></p>
            <p id="status-text" class="text-sm mt-2 sm:mt-0 text-gray-400">–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è...</p>
        </div>
        
        <p class="text-sm text-center text-indigo-400 mt-8">
            üîî –ö–Ω–æ–ø–∫–∞ **"–°–û–•–†–ê–ù–ò–¢–¨ –ò –°–ò–ù–•–†–û–ù–ò–ó–ò–†–û–í–ê–¢–¨"** –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤–Ω–∏–∑—É —ç–∫—Ä–∞–Ω–∞ (–≤ Telegram).
        </p>

    </div>
</body>
</html>
